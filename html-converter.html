<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional HTML Email Converter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #60a5fa;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #cbd5e1;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 0.25rem;
        }

        /* Main content grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Panels */
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .panel-header i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-body {
            padding: 1.5rem;
        }

        /* Code editor wrapper */
        .code-editor {
            position: relative;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .editor-info {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .editor-info span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-info i {
            color: var(--text-muted);
        }

        /* CodeMirror customization */
        .CodeMirror {
            height: 500px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .CodeMirror-focused {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .code-editor-wrapper {
            border-radius: 8px;
            overflow: hidden;
        }

        /* Preview */
        .preview-container {
            position: relative;
            height: 500px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Preview mode buttons */
        .preview-modes {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .preview-mode-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preview-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .preview-mode-btn:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-secondary);
        }

        .preview-mode-btn i {
            margin-right: 0.25rem;
        }

        /* Validation panel */
        .validation-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .validation-panel h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .validation-item:last-child {
            border-bottom: none;
        }

        .validation-item i {
            font-size: 1rem;
        }

        .validation-item.success i {
            color: var(--success);
        }

        .validation-item.warning i {
            color: var(--warning);
        }

        .validation-item.error i {
            color: var(--danger);
        }

        /* Template library */
        .template-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .template-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .template-card i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .template-card h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .template-card p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Action buttons section */
        .actions {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #059669;
            border-color: #059669;
        }

        .btn i {
            font-size: 1rem;
        }

        /* Stats cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-card h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Score breakdown tooltip */
        .score-breakdown {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: var(--shadow-lg);
            width: 250px;
            display: none;
            z-index: 100;
            margin-bottom: 0.5rem;
        }

        .score-breakdown::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--bg-primary);
        }

        .stat-card:hover .score-breakdown {
            display: block;
        }

        .score-breakdown h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-item.pass {
            color: var(--success);
        }

        .score-item.fail {
            color: var(--danger);
        }

        .score-item.warning {
            color: var(--warning);
        }

        .score-recommendation {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 0;
        }

        /* Form elements */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            min-width: 250px;
            border-left: 4px solid var(--primary);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.error i {
            color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.warning i {
            color: var(--warning);
        }

        /* Loading spinner */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .footer p {
            margin: 0.25rem 0;
        }

        /* Hidden iframe for clean HTML copying */
        #clean-copy-frame {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            border: none;
            background: white;
        }

        /* Find & Replace modal specific styles */
        #findReplaceResults {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        #findReplaceMessage {
            color: var(--text-secondary);
        }

        /* Variable highlighting in CodeMirror */
        .cm-variable {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .cm-variable-empty {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Visual score indicators */
        .score-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-good { color: var(--success); }
        .score-warning { color: var(--warning); }
        .score-poor { color: var(--danger); }

        /* Common Issues Indicator */
        .issues-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .issues-indicator:hover {
            transform: scale(1.1);
        }

        .issues-indicator.critical {
            background: var(--danger);
            color: white;
        }

        .issues-indicator.warning {
            background: var(--warning);
            color: white;
        }

        .issues-indicator.good {
            background: var(--success);
            color: white;
        }

        .issues-panel {
            position: absolute;
            top: 3.5rem;
            right: 1rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            width: 350px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 11;
        }

        .issues-panel.show {
            display: block;
        }

        .issue-item {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-item i {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .issue-critical i { color: var(--danger); }
        .issue-warning i { color: var(--warning); }
        .issue-info i { color: var(--primary); }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header:hover {
            background: var(--bg-tertiary);
            margin: -0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .collapse-arrow {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .collapsed .collapse-arrow {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsed .collapsible-content {
            max-height: 0;
        }

        /* Smart detection notification */
        .smart-detection {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .smart-detection.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .smart-detection h4 {
            color: var(--warning);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .detected-variables {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .detected-var {
            background: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-family: monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-wrap: wrap;
            }

            .toolbar .btn span {
                display: none;
            }

            .toolbar .btn {
                padding: 0.5rem 0.75rem;
            }

            .toolbar .btn i {
                margin: 0;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .actions {
                flex-wrap: wrap;
            }

            .actions .btn {
                flex: 1;
                min-width: 140px;
            }

            .panel-body {
                padding: 1rem;
            }

            .preview-modes {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.25rem;
            }

            .preview-mode-btn {
                padding: 0.4rem 0.5rem;
                font-size: 0.75rem;
            }

            .preview-mode-btn i {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .stats {
                display: none;
            }

            .footer {
                font-size: 0.75rem;
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn btn-sm" onclick="formatHTML()">
                    <i class="fas fa-indent"></i> Format
                </button>
                <button class="btn btn-sm" onclick="validateEmail()">
                    <i class="fas fa-check-circle"></i> Validate
                </button>
                <button class="btn btn-sm" onclick="inlineCSS()">
                    <i class="fas fa-compress"></i> Inline CSS
                </button>
                <button class="btn btn-sm" onclick="showFindReplace()">
                    <i class="fas fa-search"></i> Find & Replace
                </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="btn btn-sm" onclick="showTemplates()">
                    <i class="fas fa-file-alt"></i> Templates
                </button>
                <button class="btn btn-sm" onclick="insertSnippet()">
                    <i class="fas fa-puzzle-piece"></i> Snippets
                </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="btn btn-sm btn-primary" onclick="showVariables()">
                    <i class="fas fa-database"></i> Variables
                </button>
                <button class="btn btn-sm" onclick="optimizeImages()">
                    <i class="fas fa-image"></i> Optimize Images
                </button>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Code Editor Panel -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-code"></i>
                    <h2>HTML Input</h2>
                </div>
                <div class="panel-body">
                    <div class="code-editor">
                        <div class="editor-toolbar">
                            <div class="editor-info">
                                <span><i class="fas fa-font"></i> <span id="charCount">0</span> characters</span>
                                <span><i class="fas fa-list-ol"></i> <span id="lineCount">0</span> lines</span>
                                <span><i class="fas fa-exclamation-triangle"></i> <span id="errorCount">0</span> issues</span>
                                <span id="variableIndicator" style="display: none; color: var(--primary);">
                                    <i class="fas fa-database"></i> <span id="variableCount">0</span> variables
                                </span>
                            </div>
                            <button class="btn btn-sm" onclick="clearEditor()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        <div class="code-editor-wrapper">
                            <textarea 
                                id="htmlInput" 
                                placeholder="Paste your HTML email template here..."
                                spellcheck="false"
                            ></textarea>
                        </div>
                    </div>
                    
                    <!-- Email Validation Results -->
                    <div id="validationPanel" class="validation-panel" style="display: none;">
                        <h3>Email Compatibility Check</h3>
                        <div id="validationResults"></div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-eye"></i>
                    <h2>Live Preview</h2>
                    <!-- Common Issues Indicator -->
                    <div id="issuesIndicator" class="issues-indicator good" onclick="toggleIssuesPanel()" title="Click to see details">
                        <span>✓</span>
                    </div>
                    <div id="issuesPanel" class="issues-panel">
                        <h4 style="margin: 0 0 0.75rem 0;">Email Compatibility Issues</h4>
                        <div id="issuesList"></div>
                        <div id="fixButton" style="margin-top: 1rem; display: none;">
                            <button class="btn btn-sm btn-primary" onclick="autoFixIssues()" style="width: 100%;">
                                <i class="fas fa-magic"></i> Auto-Fix All Issues
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <!-- Smart Detection Notification -->
                    <div id="smartDetection" class="smart-detection">
                        <h4><i class="fas fa-lightbulb"></i> Detected Potential Variables</h4>
                        <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">Found patterns that could be converted to variables:</p>
                        <div id="detectedVariables" class="detected-variables"></div>
                        <div style="margin-top: 0.75rem;">
                            <button class="btn btn-sm btn-primary" onclick="convertDetectedVariables()">
                                <i class="fas fa-magic"></i> Convert All
                            </button>
                            <button class="btn btn-sm" onclick="dismissSmartDetection()">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                    <div class="preview-modes">
                        <button class="preview-mode-btn active" onclick="setPreviewMode('styled')">
                            <i class="fas fa-magic"></i> Styled
                        </button>
                        <button class="preview-mode-btn" onclick="setPreviewMode('raw')">
                            <i class="fas fa-code"></i> Raw HTML
                        </button>
                        <button class="preview-mode-btn" onclick="setPreviewMode('mobile')">
                            <i class="fas fa-mobile-alt"></i> Mobile
                        </button>
                        <button class="preview-mode-btn" onclick="setPreviewMode('gmail')">
                            <i class="fas fa-envelope"></i> Gmail
                        </button>
                        <button class="preview-mode-btn" onclick="setPreviewMode('outlook')">
                            <i class="fas fa-envelope-square"></i> Outlook
                        </button>
                        <button class="preview-mode-btn" onclick="setPreviewMode('apple')">
                            <i class="fas fa-apple"></i> Apple Mail
                        </button>
                        <button class="btn btn-sm" onclick="toggleEditMode()" style="margin-left: auto;">
                            <i class="fas fa-edit"></i> <span id="editModeText">Enable Live Edit</span>
                        </button>
                    </div>
                    <div class="preview-container">
                        <iframe id="preview" class="preview-frame"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <button class="btn btn-primary" onclick="uploadHTML()">
                <i class="fas fa-upload"></i> Upload HTML
            </button>
            <button class="btn btn-primary" onclick="downloadHTML()">
                <i class="fas fa-download"></i> Download HTML
            </button>
            <button class="btn" onclick="printHTML()">
                <i class="fas fa-print"></i> Print
            </button>
            <button class="btn btn-success" onclick="emailToGmail()">
                <i class="fas fa-envelope"></i> Copy for Gmail
            </button>
            <button class="btn" onclick="copyToClipboard()">
                <i class="fas fa-copy"></i> Copy Raw HTML
            </button>
            <button class="btn" onclick="saveProject()">
                <i class="fas fa-save"></i> Save Project
            </button>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <i class="fas fa-code"></i>
                <h3 id="tagCount">0</h3>
                <p>HTML Tags</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-file-alt"></i>
                <h3 id="sizeKB">0 KB</h3>
                <p>File Size</p>
            </div>
            <div class="stat-card" style="position: relative;">
                <i class="fas fa-mobile-alt"></i>
                <div class="score-indicator">
                    <h3 id="mobileScore">-</h3>
                    <span id="mobileIcon"></span>
                </div>
                <p>Mobile Score</p>
                <div id="mobileBreakdown" class="score-breakdown"></div>
            </div>
            <div class="stat-card" style="position: relative;">
                <i class="fas fa-envelope-open-text"></i>
                <div class="score-indicator">
                    <h3 id="emailScore">-</h3>
                    <span id="emailIcon"></span>
                </div>
                <p>Email Score</p>
                <div id="emailBreakdown" class="score-breakdown"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Bill Layne Insurance Agency</strong></p>
            <p>1283 N Bridge St, Elkin NC 28621 | 336-835-1993</p>
            <p>Save@BillLayneInsurance.com | www.BillLayneInsurance.com</p>
        </div>
    </div>

    <!-- Hidden iframe for clean HTML copying -->
    <iframe id="clean-copy-frame"></iframe>

    <!-- Toast notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Action completed!</span>
    </div>

    <!-- Loading spinner -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Templates</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="template-library">
                    <div class="template-card" onclick="loadTemplate('newsletter')">
                        <i class="fas fa-newspaper"></i>
                        <h4>Newsletter</h4>
                        <p>Modern newsletter layout</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('promotional')">
                        <i class="fas fa-tag"></i>
                        <h4>Promotional</h4>
                        <p>Sales & promotions</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('quote')">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h4>Insurance Quote</h4>
                        <p>Professional quote template</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('welcome')">
                        <i class="fas fa-handshake"></i>
                        <h4>Welcome Email</h4>
                        <p>Client onboarding</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('reminder')">
                        <i class="fas fa-bell"></i>
                        <h4>Reminder</h4>
                        <p>Policy renewal reminder</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('thank-you')">
                        <i class="fas fa-heart"></i>
                        <h4>Thank You</h4>
                        <p>Customer appreciation</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Find & Replace Modal -->
    <div id="findReplaceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Find & Replace</h3>
                <button class="modal-close" onclick="closeModal('findReplaceModal')">×</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="margin-bottom: 1rem;">
                    <label>Find:</label>
                    <input type="text" id="findInput" placeholder="Enter text to find...">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label>Replace with:</label>
                    <input type="text" id="replaceInput" placeholder="Enter replacement text...">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="caseSensitive">
                        <span>Case sensitive</span>
                    </label>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-sm" onclick="findNext()">
                        <i class="fas fa-search"></i> Find Next
                    </button>
                    <button class="btn btn-sm" onclick="replaceNext()">
                        <i class="fas fa-exchange-alt"></i> Replace
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="replaceAll()">
                        <i class="fas fa-sync"></i> Replace All
                    </button>
                </div>
                <div id="findReplaceResults" style="margin-top: 1rem; display: none;">
                    <span id="findReplaceMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Variable Manager Modal -->
    <div id="variableModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Variable & Merge Field Manager</h3>
                <button class="modal-close" onclick="closeModal('variableModal')">×</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Left Column - Variables -->
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
                            <i class="fas fa-code" style="color: var(--primary);"></i> Available Variables
                        </h4>
                        <div id="variablesList" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 300px; overflow-y: auto;">
                            <!-- Variables will be listed here -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="newVarName" placeholder="Variable name (e.g., client_name)" style="flex: 1;">
                            <button class="btn btn-sm btn-primary" onclick="addVariable()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div>
                            <label style="margin-bottom: 0.5rem; display: block;">Variable Set:</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="variableSet" onchange="loadVariableSet()" style="flex: 1;">
                                    <option value="default">Default Set</option>
                                    <option value="auto">Auto Insurance</option>
                                    <option value="home">Home Insurance</option>
                                    <option value="life">Life Insurance</option>
                                    <option value="custom">Custom Set</option>
                                </select>
                                <button class="btn btn-sm" onclick="saveVariableSet()">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Test Data -->
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
                            <i class="fas fa-vial" style="color: var(--success);"></i> Test Data
                        </h4>
                        <div id="testDataForm" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                            <!-- Test data inputs will be generated here -->
                        </div>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; border: 1px solid #0284c7;">
                            <p style="margin: 0; font-size: 0.875rem; color: #0c4a6e;">
                                <i class="fas fa-info-circle"></i> 
                                Use {{variable_name}} format in your HTML. Variables will be replaced with test data when you click "Apply Test Data".
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Common Variables Quick Insert -->
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
                        <i class="fas fa-bolt" style="color: var(--warning);"></i> Quick Insert Common Variables
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn btn-sm" onclick="insertVariable('client_name')">
                            <i class="fas fa-user"></i> Client Name
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('policy_number')">
                            <i class="fas fa-hashtag"></i> Policy #
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('renewal_date')">
                            <i class="fas fa-calendar"></i> Renewal Date
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('premium_amount')">
                            <i class="fas fa-dollar-sign"></i> Premium
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('agent_name')">
                            <i class="fas fa-id-badge"></i> Agent Name
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('coverage_type')">
                            <i class="fas fa-shield-alt"></i> Coverage
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('effective_date')">
                            <i class="fas fa-clock"></i> Effective Date
                        </button>
                        <button class="btn btn-sm" onclick="insertVariable('deductible')">
                            <i class="fas fa-file-invoice-dollar"></i> Deductible
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn" onclick="clearTestData()">
                        <i class="fas fa-eraser"></i> Clear Test Data
                    </button>
                    <button class="btn btn-primary" onclick="applyTestData()">
                        <i class="fas fa-play"></i> Apply Test Data
                    </button>
                    <button class="btn btn-success" onclick="removeAllVariables()">
                        <i class="fas fa-broom"></i> Remove Variables
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CodeMirror JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/html-hint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>

    <script>
        // Initialize CodeMirror
        let editor;
        const htmlInput = document.getElementById('htmlInput');
        const preview = document.getElementById('preview');
        const charCount = document.getElementById('charCount');
        const lineCount = document.getElementById('lineCount');
        const tagCount = document.getElementById('tagCount');
        const sizeKB = document.getElementById('sizeKB');
        const errorCount = document.getElementById('errorCount');
        const mobileScore = document.getElementById('mobileScore');
        const emailScore = document.getElementById('emailScore');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const loading = document.getElementById('loading');
        const validationPanel = document.getElementById('validationPanel');
        const validationResults = document.getElementById('validationResults');

        // Initialize CodeMirror with Material theme
        editor = CodeMirror.fromTextArea(htmlInput, {
            mode: 'htmlmixed',
            theme: 'material',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            placeholder: "Paste your HTML email template here...",
            tabSize: 2,
            indentUnit: 2,
            indentWithTabs: false,
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-/": "toggleComment",
                "Cmd-/": "toggleComment",
                "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
                "Cmd-Q": function(cm){ cm.foldCode(cm.getCursor()); }
            }
        });

        // Preview mode state
        let currentPreviewMode = 'styled';

        // Update preview in real-time
        let updateTimer;
        editor.on('change', () => {
            clearTimeout(updateTimer);
            updateTimer = setTimeout(() => {
                updatePreview();
                updateStats();
            }, 500);
        });

        // Initial update
        updateStats();
        
        // Fix CodeMirror sizing issue
        setTimeout(() => {
            editor.refresh();
        }, 100);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            editor.refresh();
        });

        function setPreviewMode(mode) {
            currentPreviewMode = mode;
            
            document.querySelectorAll('.preview-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.preview-mode-btn').classList.add('active');
            
            updatePreview();
        }

        function updatePreview() {
            const html = editor.getValue();
            const previewDoc = preview.contentDocument || preview.contentWindow.document;
            
            let fullHTML = '';
            
            switch(currentPreviewMode) {
                case 'raw':
                    fullHTML = html;
                    break;
                case 'mobile':
                    fullHTML = getMobileWrapper(html);
                    break;
                case 'gmail':
                    fullHTML = getGmailWrapper(html);
                    break;
                case 'outlook':
                    fullHTML = getOutlookWrapper(html);
                    break;
                case 'apple':
                    fullHTML = getAppleMailWrapper(html);
                    break;
                default:
                    fullHTML = getStyledWrapper(html);
            }
            
            previewDoc.open();
            previewDoc.write(fullHTML);
            previewDoc.close();
        }

        function getStyledWrapper(html) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        * {
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    ${html}
</body>
</html>`;
        }

        function getMobileWrapper(html) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 375px;
            max-width: 375px;
            margin: 0 auto;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    ${html}
</body>
</html>`;
        }

        function getGmailWrapper(html) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: white;
            font-family: Arial, sans-serif;
        }
        table {
            border-collapse: collapse;
        }
        .gmail-hide {
            display: none !important;
        }
    </style>
</head>
<body>
    <div style="max-width: 600px; margin: 0 auto;">
        ${html}
    </div>
</body>
</html>`;
        }

        function getOutlookWrapper(html) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--[if mso]>
    <noscript>
        <xml>
            <o:OfficeDocumentSettings>
                <o:PixelsPerInch>96</o:PixelsPerInch>
            </o:OfficeDocumentSettings>
        </xml>
    </noscript>
    <![endif]-->
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: Arial, sans-serif;
        }
        table {
            border-collapse: collapse;
            mso-table-lspace: 0pt;
            mso-table-rspace: 0pt;
        }
    </style>
</head>
<body>
    ${html}
</body>
</html>`;
        }

        function getAppleMailWrapper(html) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            -webkit-text-size-adjust: 100%;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
</head>
<body>
    ${html}
</body>
</html>`;
        }

        function updateStats() {
            const text = editor.getValue();
            
            charCount.textContent = text.length.toLocaleString();
            lineCount.textContent = editor.lineCount().toLocaleString();
            
            const tagMatches = text.match(/<[^>]+>/g) || [];
            tagCount.textContent = tagMatches.length.toLocaleString();
            
            const sizeInBytes = new Blob([text]).size;
            const sizeInKB = (sizeInBytes / 1024).toFixed(2);
            sizeKB.textContent = `${sizeInKB} KB`;
            
            // Count variables
            const variableMatches = text.match(/{{[^}]+}}/g) || [];
            const variableIndicator = document.getElementById('variableIndicator');
            const variableCount = document.getElementById('variableCount');
            if (variableMatches.length > 0) {
                variableIndicator.style.display = 'inline-flex';
                variableCount.textContent = variableMatches.length;
            } else {
                variableIndicator.style.display = 'none';
            }
            
            updateMobileScore(text);
            updateEmailScore(text);
        }

        function updateMobileScore(html) {
            let score = 100;
            const breakdown = [];
            
            // Check for viewport meta tag (-20 points)
            if (!html.includes('viewport')) {
                score -= 20;
                breakdown.push({ status: 'fail', text: 'Missing viewport tag', points: '-20' });
            } else {
                breakdown.push({ status: 'pass', text: 'Has viewport tag', points: '✓' });
            }
            
            // Check for responsive design patterns (-15 points)
            if (!html.includes('%') && !html.includes('max-width')) {
                score -= 15;
                breakdown.push({ status: 'fail', text: 'No responsive units', points: '-15' });
            } else {
                breakdown.push({ status: 'pass', text: 'Uses responsive design', points: '✓' });
            }
            
            // Check for large fixed widths
            const widthMatches = html.match(/width[:\s]*["']?(\d+)/gi) || [];
            let widthPenalty = 0;
            widthMatches.forEach(match => {
                const width = parseInt(match.match(/\d+/)[0]);
                if (width > 600) {
                    widthPenalty += 10;
                }
            });
            if (widthPenalty > 0) {
                score -= widthPenalty;
                breakdown.push({ status: 'fail', text: `Width > 600px found`, points: `-${widthPenalty}` });
            } else {
                breakdown.push({ status: 'pass', text: 'All widths ≤ 600px', points: '✓' });
            }
            
            // Check for proper font sizes
            const fontSizeMatches = html.match(/font-size[:\s]*["']?(\d+)/gi) || [];
            let fontPenalty = 0;
            fontSizeMatches.forEach(match => {
                const size = parseInt(match.match(/\d+/)[0]);
                if (size < 14) {
                    fontPenalty += 5;
                }
            });
            if (fontPenalty > 0) {
                score -= fontPenalty;
                breakdown.push({ status: 'warning', text: `Small fonts < 14px`, points: `-${fontPenalty}` });
            } else if (fontSizeMatches.length > 0) {
                breakdown.push({ status: 'pass', text: 'Font sizes ≥ 14px', points: '✓' });
            }
            
            score = Math.max(0, score);
            mobileScore.textContent = score + '%';
            
            // Add visual indicator
            const mobileIcon = document.getElementById('mobileIcon');
            const scoreElement = mobileScore.parentElement;
            if (score >= 80) {
                mobileIcon.innerHTML = '✓';
                scoreElement.className = 'score-indicator score-good';
            } else if (score >= 60) {
                mobileIcon.innerHTML = '⚠';
                scoreElement.className = 'score-indicator score-warning';
            } else {
                mobileIcon.innerHTML = '✗';
                scoreElement.className = 'score-indicator score-poor';
            }
            
            // Update breakdown tooltip
            const breakdownEl = document.getElementById('mobileBreakdown');
            let recommendation = '';
            if (score >= 80) {
                recommendation = '✓ Mobile-friendly';
            } else if (score >= 60) {
                recommendation = '⚠ Could be improved for mobile';
            } else {
                recommendation = '✗ Needs mobile optimization';
            }
            
            breakdownEl.innerHTML = `
                <h4>Mobile Score Breakdown</h4>
                ${breakdown.map(item => `
                    <div class="score-item ${item.status}">
                        <span>${item.text}</span>
                        <span>${item.points}</span>
                    </div>
                `).join('')}
                <div class="score-recommendation">
                    <strong>Status:</strong> ${recommendation}
                </div>
            `;
        }

        function updateEmailScore(html) {
            let score = 100;
            let issues = 0;
            const issuesList = [];
            const breakdown = [];
            
            // Track issues with detailed breakdown
            if (html.includes('position:') && !html.includes('position: relative')) { 
                score -= 10; 
                issues++;
                const lineNum = getLineNumber(html, 'position:');
                issuesList.push({ type: 'critical', message: `CSS positioning on line ${lineNum} - not supported in most email clients` });
                breakdown.push({ status: 'fail', text: 'CSS positioning', points: '-10' });
            } else {
                breakdown.push({ status: 'pass', text: 'No positioning issues', points: '✓' });
            }
            
            if (html.includes('float:')) { 
                score -= 10; 
                issues++;
                const lineNum = getLineNumber(html, 'float:');
                issuesList.push({ type: 'critical', message: `Float property on line ${lineNum} - use tables instead` });
                breakdown.push({ status: 'fail', text: 'Float property', points: '-10' });
            }
            
            if (html.includes('flex')) { 
                score -= 15; 
                issues++;
                const lineNum = getLineNumber(html, 'flex');
                issuesList.push({ type: 'warning', message: `Flexbox on line ${lineNum} - limited support` });
                breakdown.push({ status: 'warning', text: 'Flexbox usage', points: '-15' });
            }
            
            if (html.includes('grid')) { 
                score -= 15; 
                issues++;
                const lineNum = getLineNumber(html, 'grid');
                issuesList.push({ type: 'critical', message: `CSS Grid on line ${lineNum} - not supported` });
                breakdown.push({ status: 'fail', text: 'CSS Grid', points: '-15' });
            }
            
            if (html.includes('<script')) { 
                score -= 20; 
                issues++;
                const lineNum = getLineNumber(html, '<script');
                issuesList.push({ type: 'critical', message: `JavaScript on line ${lineNum} - will be blocked` });
                breakdown.push({ status: 'fail', text: 'JavaScript', points: '-20' });
            }
            
            if (html.includes('<link') && html.includes('stylesheet')) { 
                score -= 15; 
                issues++;
                const lineNum = getLineNumber(html, '<link');
                issuesList.push({ type: 'warning', message: `External CSS on line ${lineNum} - inline styles instead` });
                breakdown.push({ status: 'warning', text: 'External CSS', points: '-15' });
            }
            
            if (html.includes('<form')) { 
                score -= 10; 
                issues++;
                const lineNum = getLineNumber(html, '<form');
                issuesList.push({ type: 'critical', message: `Form on line ${lineNum} - blocked in email clients` });
                breakdown.push({ status: 'fail', text: 'Form elements', points: '-10' });
            }
            
            if (html.includes('<video') || html.includes('<audio')) { 
                score -= 10; 
                issues++;
                const lineNum = getLineNumber(html, '<video') || getLineNumber(html, '<audio');
                issuesList.push({ type: 'critical', message: `Media element on line ${lineNum} - not supported` });
                breakdown.push({ status: 'fail', text: 'Media elements', points: '-10' });
            }
            
            // Check for missing alt text
            const imgMatches = html.match(/<img[^>]+>/gi) || [];
            let altTextMissing = 0;
            imgMatches.forEach((img, index) => {
                if (!img.includes('alt=')) {
                    altTextMissing++;
                    const lineNum = getLineNumber(html, img);
                    issuesList.push({ type: 'warning', message: `Image missing alt text on line ${lineNum}` });
                }
            });
            if (altTextMissing > 0) {
                breakdown.push({ status: 'warning', text: `${altTextMissing} images no alt`, points: '⚠' });
            }
            
            // Check for table width
            const tableMatches = html.match(/<table[^>]+>/gi) || [];
            let wideTableCount = 0;
            tableMatches.forEach(table => {
                const widthMatch = table.match(/width[=:]["']?(\d+)/i);
                if (widthMatch && parseInt(widthMatch[1]) > 600) {
                    wideTableCount++;
                    const lineNum = getLineNumber(html, table);
                    issuesList.push({ type: 'warning', message: `Table width exceeds 600px on line ${lineNum}` });
                }
            });
            if (wideTableCount > 0) {
                breakdown.push({ status: 'warning', text: `${wideTableCount} wide tables`, points: '⚠' });
            }
            
            // Bonus points for good practices
            if (html.includes('<table')) {
                breakdown.push({ status: 'pass', text: 'Uses tables', points: '✓' });
            }
            
            score = Math.max(0, score);
            emailScore.textContent = score + '%';
            errorCount.textContent = issues;
            
            // Add visual indicator
            const emailIcon = document.getElementById('emailIcon');
            const scoreElement = emailScore.parentElement;
            if (score >= 80) {
                emailIcon.innerHTML = '✓';
                scoreElement.className = 'score-indicator score-good';
            } else if (score >= 60) {
                emailIcon.innerHTML = '⚠';
                scoreElement.className = 'score-indicator score-warning';
            } else {
                emailIcon.innerHTML = '✗';
                scoreElement.className = 'score-indicator score-poor';
            }
            
            // Update breakdown tooltip
            const breakdownEl = document.getElementById('emailBreakdown');
            let recommendation = '';
            if (score >= 80) {
                recommendation = '✓ Email client compatible';
            } else if (score >= 60) {
                recommendation = '⚠ May have display issues';
            } else {
                recommendation = '✗ Will break in email clients';
            }
            
            breakdownEl.innerHTML = `
                <h4>Email Score Breakdown</h4>
                ${breakdown.map(item => `
                    <div class="score-item ${item.status}">
                        <span>${item.text}</span>
                        <span>${item.points}</span>
                    </div>
                `).join('')}
                <div class="score-recommendation">
                    <strong>Status:</strong> ${recommendation}
                </div>
            `;
            
            // Update Common Issues Indicator
            updateIssuesIndicator(issuesList);
        }

        function getLineNumber(text, search) {
            const index = text.indexOf(search);
            if (index === -1) return 0;
            return text.substring(0, index).split('\n').length;
        }

        function updateIssuesIndicator(issues) {
            const indicator = document.getElementById('issuesIndicator');
            const issuesListElement = document.getElementById('issuesList');
            const fixButton = document.getElementById('fixButton');
            
            if (!issues || issues.length === 0) {
                indicator.className = 'issues-indicator good';
                indicator.innerHTML = '<span>✓</span>';
                indicator.title = 'No issues detected';
                issuesListElement.innerHTML = '<p style="color: var(--success);">✓ No compatibility issues found!</p>';
                fixButton.style.display = 'none';
            } else {
                const critical = issues.filter(i => i.type === 'critical').length;
                const warnings = issues.filter(i => i.type === 'warning').length;
                
                if (critical > 0) {
                    indicator.className = 'issues-indicator critical';
                    indicator.innerHTML = `<span>${critical}</span>`;
                    indicator.title = `${critical} critical issue${critical > 1 ? 's' : ''}`;
                } else if (warnings > 0) {
                    indicator.className = 'issues-indicator warning';
                    indicator.innerHTML = `<span>${warnings}</span>`;
                    indicator.title = `${warnings} warning${warnings > 1 ? 's' : ''}`;
                }
                
                // Populate issues list
                issuesListElement.innerHTML = issues.map(issue => `
                    <div class="issue-item issue-${issue.type}">
                        <i class="fas fa-${issue.type === 'critical' ? 'times-circle' : 'exclamation-triangle'}"></i>
                        <span>${issue.message}</span>
                    </div>
                `).join('');
                
                // Show fix button
                fixButton.style.display = 'block';
            }
        }

        function autoFixIssues() {
            let html = editor.getValue();
            let fixCount = 0;
            
            // Fix 1: Replace position absolute/fixed/relative with table layout
            if (html.includes('position:')) {
                html = html.replace(/position\s*:\s*(absolute|fixed|relative)[^;]*/gi, '');
                fixCount++;
            }
            
            // Fix 2: Replace float with table align
            if (html.includes('float:')) {
                // Replace float:left with align="left"
                html = html.replace(/style\s*=\s*"([^"]*?)float\s*:\s*left[^;]*;?([^"]*?)"/gi, (match, before, after) => {
                    const cleanStyle = (before + after).trim();
                    return cleanStyle ? `style="${cleanStyle}" align="left"` : 'align="left"';
                });
                
                // Replace float:right with align="right"
                html = html.replace(/style\s*=\s*"([^"]*?)float\s*:\s*right[^;]*;?([^"]*?)"/gi, (match, before, after) => {
                    const cleanStyle = (before + after).trim();
                    return cleanStyle ? `style="${cleanStyle}" align="right"` : 'align="right"';
                });
                
                // Clean up any remaining float properties
                html = html.replace(/float\s*:\s*[^;]*/gi, '');
                fixCount++;
            }
            
            // Fix 3: Replace flexbox with table layout
            if (html.includes('flex')) {
                // Replace display:flex containers with tables
                html = html.replace(/display\s*:\s*flex[^;]*/gi, 'display: table');
                html = html.replace(/flex-direction[^;]*/gi, '');
                html = html.replace(/justify-content[^;]*/gi, '');
                html = html.replace(/align-items[^;]*/gi, '');
                html = html.replace(/flex[^;]*/gi, '');
                fixCount++;
            }
            
            // Fix 4: Replace CSS Grid with table layout
            if (html.includes('grid')) {
                html = html.replace(/display\s*:\s*grid[^;]*/gi, 'display: table');
                html = html.replace(/grid-template[^;]*/gi, '');
                html = html.replace(/grid-column[^;]*/gi, '');
                html = html.replace(/grid-row[^;]*/gi, '');
                html = html.replace(/grid-gap[^;]*/gi, '');
                fixCount++;
            }
            
            // Fix 5: Add alt tags to images
            const imgRegex = /<img(?![^>]*\balt\s*=)[^>]*>/gi;
            html = html.replace(imgRegex, (match) => {
                fixCount++;
                // Insert alt="" before the closing >
                return match.replace(/\/?>/, ' alt=""$&');
            });
            
            // Fix 6: Reduce table widths over 600px
            html = html.replace(/(<table[^>]*width\s*=\s*["']?)(\d+)([^0-9][^>]*>)/gi, (match, before, width, after) => {
                const widthNum = parseInt(width);
                if (widthNum > 600) {
                    fixCount++;
                    return before + '600' + after;
                }
                return match;
            });
            
            // Fix 7: Remove script tags
            if (html.includes('<script')) {
                html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                fixCount++;
            }
            
            // Fix 8: Remove form tags but keep content
            if (html.includes('<form')) {
                html = html.replace(/<form[^>]*>/gi, '<div>');
                html = html.replace(/<\/form>/gi, '</div>');
                fixCount++;
            }
            
            // Fix 9: Remove video and audio tags
            if (html.includes('<video') || html.includes('<audio')) {
                html = html.replace(/<video\b[^<]*(?:(?!<\/video>)<[^<]*)*<\/video>/gi, '');
                html = html.replace(/<audio\b[^<]*(?:(?!<\/audio>)<[^<]*)*<\/audio>/gi, '');
                fixCount++;
            }
            
            // Fix 10: Convert external stylesheets to inline
            if (html.includes('<link') && html.includes('stylesheet')) {
                html = html.replace(/<link[^>]*stylesheet[^>]*>/gi, '');
                fixCount++;
            }
            
            // Fix 11: Wrap content in proper email table structure if missing
            if (!html.includes('<table')) {
                html = `<table width="100%" cellpadding="0" cellspacing="0" style="max-width: 600px; margin: 0 auto;">
    <tr>
        <td>
            ${html}
        </td>
    </tr>
</table>`;
                fixCount++;
            }
            
            // Fix 12: Clean up empty style attributes
            html = html.replace(/style\s*=\s*"[\s;]*"/gi, '');
            
            // Fix 13: Ensure proper DOCTYPE for email
            if (!html.includes('<!DOCTYPE')) {
                html = '<!DOCTYPE html>\n' + html;
                fixCount++;
            }
            
            // Fix 14: Add viewport meta tag if missing
            if (!html.includes('viewport') && html.includes('<head>')) {
                html = html.replace('<head>', '<head>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">');
                fixCount++;
            }
            
            // Update editor with fixed HTML
            editor.setValue(html);
            updatePreview();
            updateStats();
            
            // Hide issues panel after fixing
            document.getElementById('issuesPanel').classList.remove('show');
            
            showToast(`Fixed ${fixCount} compatibility issue${fixCount !== 1 ? 's' : ''}! Your email is now optimized.`);
        }

        function toggleIssuesPanel() {
            const panel = document.getElementById('issuesPanel');
            panel.classList.toggle('show');
        }

        // Smart Variable Detection
        function detectPotentialVariables() {
            const html = editor.getValue();
            const patterns = [
                /\[([A-Z_]+)\]/g,           // [CLIENT_NAME]
                /%([A-Z_]+)%/g,             // %POLICY_NUMBER%
                /\{\{([^}]+)\}\}/g,         // {{variable}} (existing)
                /\$\{([^}]+)\}/g,           // ${variable}
                /\[\[([^\]]+)\]\]/g         // [[variable]]
            ];
            
            const detectedVars = new Set();
            const existingVars = new Set(variables);
            
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(html)) !== null) {
                    const varName = match[1].toLowerCase().replace(/\s+/g, '_');
                    if (!existingVars.has(varName) && !varName.startsWith('{{')) {
                        detectedVars.add(varName);
                    }
                }
            });
            
            if (detectedVars.size > 0) {
                showSmartDetection(Array.from(detectedVars));
            }
        }

        function showSmartDetection(detectedVars) {
            const container = document.getElementById('detectedVariables');
            const notification = document.getElementById('smartDetection');
            
            container.innerHTML = detectedVars.map(varName => `
                <span class="detected-var">${varName}</span>
            `).join('');
            
            notification.classList.add('show');
            
            // Store for conversion
            window.detectedVariables = detectedVars;
        }

        function convertDetectedVariables() {
            if (!window.detectedVariables) return;
            
            let html = editor.getValue();
            const patterns = [
                { regex: /\[([A-Z_]+)\]/g, replace: (match, p1) => `{{${p1.toLowerCase()}}}` },
                { regex: /%([A-Z_]+)%/g, replace: (match, p1) => `{{${p1.toLowerCase()}}}` },
                { regex: /\$\{([^}]+)\}/g, replace: (match, p1) => `{{${p1.toLowerCase()}}}` },
                { regex: /\[\[([^\]]+)\]\]/g, replace: (match, p1) => `{{${p1.toLowerCase()}}}` }
            ];
            
            patterns.forEach(pattern => {
                html = html.replace(pattern.regex, pattern.replace);
            });
            
            // Add to variables list
            window.detectedVariables.forEach(varName => {
                if (!variables.includes(varName)) {
                    variables.push(varName);
                    testData[varName] = '';
                }
            });
            
            editor.setValue(html);
            saveVariables();
            dismissSmartDetection();
            showToast(`Converted ${window.detectedVariables.length} variables`);
            updateStats();
        }

        function dismissSmartDetection() {
            const notification = document.getElementById('smartDetection');
            notification.classList.remove('show');
            window.detectedVariables = null;
        }

        // Variable Highlighting in CodeMirror
        function highlightVariables() {
            const text = editor.getValue();
            const variableRegex = /\{\{([^}]+)\}\}/g;
            let match;
            
            while ((match = variableRegex.exec(text)) !== null) {
                const varName = match[1];
                const from = editor.posFromIndex(match.index);
                const to = editor.posFromIndex(match.index + match[0].length);
                
                const hasTestData = testData[varName] && testData[varName].trim();
                const className = hasTestData ? 'cm-variable' : 'cm-variable-empty';
                
                editor.markText(from, to, { 
                    className: className,
                    title: hasTestData ? testData[varName] : 'No test data'
                });
            }
        }

        // Enhanced updateStats with detection
        function updateStats() {
            const text = editor.getValue();
            
            charCount.textContent = text.length.toLocaleString();
            lineCount.textContent = editor.lineCount().toLocaleString();
            
            const tagMatches = text.match(/<[^>]+>/g) || [];
            tagCount.textContent = tagMatches.length.toLocaleString();
            
            const sizeInBytes = new Blob([text]).size;
            const sizeInKB = (sizeInBytes / 1024).toFixed(2);
            sizeKB.textContent = `${sizeInKB} KB`;
            
            // Count variables
            const variableMatches = text.match(/{{[^}]+}}/g) || [];
            const variableIndicator = document.getElementById('variableIndicator');
            const variableCount = document.getElementById('variableCount');
            if (variableMatches.length > 0) {
                variableIndicator.style.display = 'inline-flex';
                variableCount.textContent = variableMatches.length;
            } else {
                variableIndicator.style.display = 'none';
            }
            
            updateMobileScore(text);
            updateEmailScore(text);
            
            // Check for potential variables
            detectPotentialVariables();
            
            // Highlight variables in editor
            setTimeout(highlightVariables, 100);
        }

        function formatHTML() {
            const html = editor.getValue();
            
            let formatted = html
                .replace(/></g, '>\n<')
                .replace(/\n\s*\n/g, '\n')
                .trim();
            
            const lines = formatted.split('\n');
            let indentLevel = 0;
            const formattedLines = lines.map(line => {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('</')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                const indentedLine = '  '.repeat(indentLevel) + trimmedLine;
                
                if (trimmedLine.startsWith('<') && !trimmedLine.startsWith('</') && 
                    !trimmedLine.endsWith('/>') && !trimmedLine.includes('/>')) {
                    const voidElements = ['area', 'base', 'br', 'col', 'embed', 'hr', 'img', 'input', 'link', 'meta', 'param', 'source', 'track', 'wbr'];
                    const tagName = trimmedLine.match(/<(\w+)/)?.[1]?.toLowerCase();
                    if (!voidElements.includes(tagName)) {
                        indentLevel++;
                    }
                }
                
                return indentedLine;
            });
            
            editor.setValue(formattedLines.join('\n'));
            showToast('HTML formatted successfully!');
        }

        function validateEmail() {
            const html = editor.getValue();
            const results = [];
            
            const checks = [
                {
                    test: !html.includes('<!DOCTYPE'),
                    type: 'error',
                    message: 'Missing DOCTYPE declaration'
                },
                {
                    test: html.includes('<script'),
                    type: 'error',
                    message: 'JavaScript is not supported in most email clients'
                },
                {
                    test: html.includes('position:') && !html.includes('position: relative'),
                    type: 'error',
                    message: 'CSS positioning (except relative) is not well supported'
                },
                {
                    test: html.includes('flex'),
                    type: 'warning',
                    message: 'Flexbox has limited support in email clients'
                },
                {
                    test: html.includes('<form'),
                    type: 'error',
                    message: 'Forms are blocked in most email clients'
                },
                {
                    test: !html.includes('<table'),
                    type: 'warning',
                    message: 'Consider using tables for better email client compatibility'
                },
                {
                    test: html.includes('background-image'),
                    type: 'warning',
                    message: 'Background images have limited support'
                },
                {
                    test: !html.includes('alt='),
                    type: 'warning',
                    message: 'Images should have alt text for accessibility'
                },
                {
                    test: html.match(/width[:\s]*["']?(\d+)/gi)?.some(m => parseInt(m.match(/\d+/)[0]) > 600),
                    type: 'warning',
                    message: 'Content wider than 600px may not display properly'
                },
                {
                    test: html.length > 102400,
                    type: 'warning',
                    message: 'HTML size exceeds 100KB - may be clipped by Gmail'
                }
            ];
            
            checks.forEach(check => {
                if (check.test) {
                    results.push(check);
                }
            });
            
            if (results.length === 0) {
                results.push({
                    type: 'success',
                    message: 'No major email compatibility issues found!'
                });
            }
            
            validationResults.innerHTML = results.map(result => `
                <div class="validation-item ${result.type}">
                    <i class="fas fa-${result.type === 'error' ? 'times-circle' : result.type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <span>${result.message}</span>
                </div>
            `).join('');
            
            validationPanel.style.display = 'block';
            showToast(`Validation complete: ${results.filter(r => r.type === 'error').length} errors, ${results.filter(r => r.type === 'warning').length} warnings`);
        }

        function inlineCSS() {
            showToast('Inlining CSS for email compatibility...', 'info');
            
            let html = editor.getValue();
            
            const styleMatches = html.match(/<style[^>]*>([\s\S]*?)<\/style>/gi) || [];
            let styles = '';
            
            styleMatches.forEach(styleBlock => {
                const cssContent = styleBlock.replace(/<\/?style[^>]*>/gi, '');
                styles += cssContent + '\n';
                html = html.replace(styleBlock, '');
            });
            
            const rules = styles.match(/([^{]+){([^}]+)}/g) || [];
            
            rules.forEach(rule => {
                const [selector, cssText] = rule.split('{');
                const cleanSelector = selector.trim();
                const cleanCss = cssText.replace('}', '').trim();
                
                if (cleanSelector && !cleanSelector.includes(':') && !cleanSelector.includes('@')) {
                    const regex = new RegExp(`<${cleanSelector}([^>]*)>`, 'gi');
                    html = html.replace(regex, (match, attributes) => {
                        if (attributes.includes('style=')) {
                            return match.replace(/style="([^"]*)"/, `style="$1; ${cleanCss}"`);
                        } else {
                            return `<${cleanSelector}${attributes} style="${cleanCss}">`;
                        }
                    });
                }
            });
            
            editor.setValue(html);
            showToast('CSS inlined successfully!');
        }
        
        function showTemplates() {
            document.getElementById('templateModal').classList.add('show');
        }

        function loadTemplate(templateType) {
            const templates = {
                'newsletter': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; margin: 20px auto;">
                    <!-- Header -->
                    <tr>
                        <td style="padding: 40px 30px; text-align: center; background-color: #2c3e50;">
                            <h1 style="color: #ffffff; margin: 0;">Your Newsletter Title</h1>
                        </td>
                    </tr>
                    <!-- Content -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #2c3e50; margin-bottom: 20px;">Hello [Name],</h2>
                            <p style="color: #666666; line-height: 1.6; margin-bottom: 20px;">
                                Welcome to our newsletter! Here's what's new this month...
                            </p>
                            <table width="100%" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td align="center" style="padding: 20px 0;">
                                        <a href="#" style="display: inline-block; padding: 12px 30px; background-color: #3498db; color: #ffffff; text-decoration: none; border-radius: 5px;">Read More</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="padding: 30px; text-align: center; background-color: #ecf0f1;">
                            <p style="color: #666666; margin: 0; font-size: 14px;">
                                Bill Layne Insurance Agency<br>
                                1283 N Bridge St, Elkin NC 28621<br>
                                336-835-1993
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`,
                'quote': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Quote</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
    <table width="100%" cellpadding="0" cellspacing="0">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; margin: 20px auto; border: 1px solid #e0e0e0;">
                    <!-- Header -->
                    <tr>
                        <td style="padding: 30px; background-color: #1e3a8a;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 24px;">Your Insurance Quote</h1>
                        </td>
                    </tr>
                    <!-- Quote Details -->
                    <tr>
                        <td style="padding: 30px;">
                            <h2 style="color: #1e3a8a; margin-bottom: 20px;">Quote Summary</h2>
                            <table width="100%" cellpadding="10" cellspacing="0" style="border: 1px solid #e0e0e0;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="font-weight: bold;">Coverage Type</td>
                                    <td style="text-align: right;">Premium</td>
                                </tr>
                                <tr>
                                    <td>Auto Insurance</td>
                                    <td style="text-align: right;">$150/month</td>
                                </tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td>Home Insurance</td>
                                    <td style="text-align: right;">$125/month</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Total Monthly Premium</td>
                                    <td style="text-align: right; font-weight: bold; color: #1e3a8a;">$275/month</td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                                <tr>
                                    <td align="center">
                                        <a href="#" style="display: inline-block; padding: 15px 40px; background-color: #10b981; color: #ffffff; text-decoration: none; border-radius: 5px; font-weight: bold;">Accept Quote</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="padding: 20px; background-color: #f8f9fa; text-align: center;">
                            <p style="color: #666666; margin: 5px 0; font-size: 14px;">
                                Bill Layne Insurance Agency | 336-835-1993<br>
                                Save@BillLayneInsurance.com
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`
            };
            
            if (templates[templateType]) {
                editor.setValue(templates[templateType]);
                closeModal('templateModal');
                showToast(`${templateType} template loaded!`);
            }
        }

        // Live Edit mode functionality
        let isEditMode = false;
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editModeText = document.getElementById('editModeText');
            
            if (isEditMode) {
                editModeText.textContent = 'Disable Live Edit';
                const previewDoc = preview.contentDocument || preview.contentWindow.document;
                previewDoc.designMode = 'on';
                previewDoc.body.contentEditable = true;
                showToast('Live edit mode enabled - click in preview to edit');
            } else {
                editModeText.textContent = 'Enable Live Edit';
                const previewDoc = preview.contentDocument || preview.contentWindow.document;
                previewDoc.designMode = 'off';
                previewDoc.body.contentEditable = false;
                const editedHTML = previewDoc.documentElement.outerHTML;
                editor.setValue(editedHTML);
                showToast('Live edit mode disabled - changes saved');
            }
        }

        // Find & Replace functionality
        let searchCursor = null;
        
        function showFindReplace() {
            document.getElementById('findReplaceModal').classList.add('show');
            document.getElementById('findInput').focus();
        }
        
        function findNext() {
            const findInput = document.getElementById('findInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!findInput) {
                showFindReplaceMessage('Please enter text to find', 'warning');
                return;
            }
            
            if (!searchCursor || searchCursor.findNext() === false) {
                searchCursor = editor.getSearchCursor(findInput, null, !caseSensitive);
                if (!searchCursor.findNext()) {
                    showFindReplaceMessage('No matches found', 'info');
                    return;
                }
            }
            
            editor.setSelection(searchCursor.from(), searchCursor.to());
            editor.scrollIntoView(searchCursor.from());
            showFindReplaceMessage('Found match', 'success');
        }
        
        function replaceNext() {
            const findInput = document.getElementById('findInput').value;
            const replaceInput = document.getElementById('replaceInput').value;
            
            if (!findInput) {
                showFindReplaceMessage('Please enter text to find', 'warning');
                return;
            }
            
            if (searchCursor && searchCursor.from()) {
                searchCursor.replace(replaceInput);
                findNext();
                showFindReplaceMessage('Replaced 1 occurrence', 'success');
            } else {
                findNext();
            }
        }
        
        function replaceAll() {
            const findInput = document.getElementById('findInput').value;
            const replaceInput = document.getElementById('replaceInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!findInput) {
                showFindReplaceMessage('Please enter text to find', 'warning');
                return;
            }
            
            let count = 0;
            const cursor = editor.getSearchCursor(findInput, null, !caseSensitive);
            
            while (cursor.findNext()) {
                cursor.replace(replaceInput);
                count++;
            }
            
            if (count > 0) {
                showFindReplaceMessage(`Replaced ${count} occurrence${count > 1 ? 's' : ''}`, 'success');
            } else {
                showFindReplaceMessage('No matches found', 'info');
            }
            
            searchCursor = null;
        }
        
        function showFindReplaceMessage(message, type) {
            const resultsDiv = document.getElementById('findReplaceResults');
            const messageSpan = document.getElementById('findReplaceMessage');
            
            messageSpan.textContent = message;
            resultsDiv.style.display = 'block';
            
            resultsDiv.style.borderColor = type === 'success' ? 'var(--success)' : 
                                          type === 'warning' ? 'var(--warning)' : 
                                          'var(--primary)';
        }

        function insertSnippet() {
            const snippetType = prompt('Choose snippet type:\n1. Button\n2. Image\n3. Two Column\n4. Social Icons', '1');
            
            let snippet = '';
            
            switch(snippetType) {
                case '1':
                    snippet = `<table width="100%" cellpadding="0" cellspacing="0">
    <tr>
        <td align="center" style="padding: 20px 0;">
            <a href="#" style="display: inline-block; padding: 15px 30px; background-color: #3498db; color: #ffffff; text-decoration: none; border-radius: 5px; font-weight: bold;">Call to Action</a>
        </td>
    </tr>
</table>`;
                    break;
                case '2':
                    snippet = `<table width="100%" cellpadding="0" cellspacing="0">
    <tr>
        <td align="center" style="padding: 20px 0;">
            <img src="" alt="Description" style="max-width: 100%; height: auto; display: block;">
        </td>
    </tr>
</table>`;
                    break;
                case '3':
                    snippet = `<table width="100%" cellpadding="0" cellspacing="0">
    <tr>
        <td width="50%" style="padding: 20px; vertical-align: top;">
            <h3 style="margin-top: 0;">Column 1</h3>
            <p>Content for the first column.</p>
        </td>
        <td width="50%" style="padding: 20px; vertical-align: top;">
            <h3 style="margin-top: 0;">Column 2</h3>
            <p>Content for the second column.</p>
        </td>
    </tr>
</table>`;
                    break;
                case '4':
                    snippet = `<table width="100%" cellpadding="0" cellspacing="0">
    <tr>
        <td align="center" style="padding: 20px;">
            <a href="#" style="display: inline-block; margin: 0 5px;"><img src="https://img.icons8.com/color/48/facebook.png" alt="Facebook" width="32" height="32"></a>
            <a href="#" style="display: inline-block; margin: 0 5px;"><img src="https://img.icons8.com/color/48/twitter.png" alt="Twitter" width="32" height="32"></a>
            <a href="#" style="display: inline-block; margin: 0 5px;"><img src="https://img.icons8.com/color/48/linkedin.png" alt="LinkedIn" width="32" height="32"></a>
        </td>
    </tr>
</table>`;
                    break;
                default:
                    snippet = `<table width="100%" cellpadding="0" cellspacing="0">
    <tr>
        <td align="center" style="padding: 20px 0;">
            <a href="#" style="display: inline-block; padding: 15px 30px; background-color: #3498db; color: #ffffff; text-decoration: none; border-radius: 5px; font-weight: bold;">Call to Action</a>
        </td>
    </tr>
</table>`;
            }
            
            editor.replaceSelection(snippet);
            showToast('Snippet inserted!');
        }
        
        function clearEditor() {
            if (confirm('Are you sure you want to clear all content?')) {
                editor.setValue('');
                editor.clearHistory();
                updatePreview();
                updateStats();
                validationPanel.style.display = 'none';
                showToast('Content cleared');
            }
        }

        function downloadHTML() {
            const html = editor.getValue();
            if (!html.trim()) {
                showToast('No HTML content to download', 'error');
                return;
            }

            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-template-${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('HTML downloaded successfully!');
        }

        function printHTML() {
            const html = editor.getValue();
            if (!html.trim()) {
                showToast('No HTML content to print', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
            
            showToast('Opening print dialog...');
        }

        // CRITICAL: Gmail copy function that preserves formatting
        function emailToGmail() {
            const html = editor.getValue();
            if (!html.trim()) {
                showToast('No HTML content to email', 'error');
                return;
            }

            // Copy formatted HTML to clipboard for Gmail
            copyFormattedHTMLToClipboard(html);
            
            const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1&tf=1';
            window.open(gmailUrl, '_blank');
            
            showToast('Formatted HTML copied! Paste it into your Gmail compose window.');
        }

        function uploadHTML() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html,.htm';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.html') && !file.name.endsWith('.htm')) {
                    showToast('Please select an HTML file', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        editor.setValue(content);
                        updatePreview();
                        updateStats();
                        showToast(`Loaded ${file.name} successfully!`);
                    } catch (err) {
                        showToast('Failed to load HTML file', 'error');
                        console.error('Error loading file:', err);
                    }
                };
                
                reader.onerror = () => {
                    showToast('Error reading file', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Copy formatted HTML for Gmail (preserves styling)
        function copyFormattedHTMLToClipboard(html) {
            // Clean the HTML for Gmail
            const cleanedHTML = cleanHTMLForGmail(html);
            
            // Create a container for the HTML
            const container = document.createElement('div');
            container.innerHTML = cleanedHTML;
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '-9999px';
            container.style.background = 'white';
            container.style.color = 'black';
            container.style.fontFamily = 'Arial, sans-serif';
            
            document.body.appendChild(container);

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.write) {
                const clipboardItem = new ClipboardItem({
                    'text/html': new Blob([cleanedHTML], { type: 'text/html' }),
                    'text/plain': new Blob([container.innerText || container.textContent], { type: 'text/plain' })
                });
                
                navigator.clipboard.write([clipboardItem]).then(() => {
                    document.body.removeChild(container);
                    showToast('Formatted HTML copied for Gmail!');
                }).catch(() => {
                    copyHTMLViaSelection(container, cleanedHTML);
                });
            } else {
                copyHTMLViaSelection(container, cleanedHTML);
            }
        }

        // Clean HTML for Gmail
        function cleanHTMLForGmail(html) {
            let cleaned = html;
            
            // Remove problematic tags
            cleaned = cleaned.replace(/<title[^>]*>.*?<\/title>/gis, '');
            cleaned = cleaned.replace(/<head[^>]*>.*?<\/head>/gis, '');
            cleaned = cleaned.replace(/<\/?html[^>]*>/gi, '');
            cleaned = cleaned.replace(/<\/?body[^>]*>/gi, '');
            cleaned = cleaned.replace(/<!DOCTYPE[^>]*>/gi, '');
            
            return cleaned.trim();
        }

        function copyHTMLViaSelection(container, html) {
            try {
                const range = document.createRange();
                range.selectNodeContents(container);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                document.execCommand('copy');
                
                selection.removeAllRanges();
                document.body.removeChild(container);
                
                showToast('Formatted HTML copied for Gmail!');
            } catch (err) {
                document.body.removeChild(container);
                copyRawHTMLToClipboard(html);
                showToast('HTML copied as text - may need to switch to HTML mode in Gmail');
            }
        }

        // Copy raw HTML (as text)
        function copyRawHTMLToClipboard(html) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(html).then(() => {
                    showToast('Raw HTML copied to clipboard!');
                }).catch(() => {
                    fallbackCopyRawHTML(html);
                });
            } else {
                fallbackCopyRawHTML(html);
            }
        }

        function fallbackCopyRawHTML(html) {
            const textarea = document.createElement('textarea');
            textarea.value = html;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '-9999px';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showToast('Raw HTML copied to clipboard!');
            } catch (err) {
                showToast('Failed to copy to clipboard', 'error');
            }
            
            document.body.removeChild(textarea);
        }

        function copyToClipboard() {
            const html = editor.getValue();
            if (!html.trim()) {
                showToast('No HTML content to copy', 'error');
                return;
            }

            copyRawHTMLToClipboard(html);
        }

        function saveProject() {
            const html = editor.getValue();
            const projectData = {
                html: html,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            localStorage.setItem('emailProject', JSON.stringify(projectData));
            showToast('Project saved locally!');
        }

        function loadProject() {
            const saved = localStorage.getItem('emailProject');
            if (saved) {
                const projectData = JSON.parse(saved);
                editor.setValue(projectData.html);
                updatePreview();
                updateStats();
                showToast('Project loaded!');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function optimizeImages() {
            const html = editor.getValue();
            const imgRegex = /<img[^>]+>/gi;
            const matches = html.match(imgRegex) || [];
            
            if (matches.length === 0) {
                showToast('No images found to optimize', 'info');
                return;
            }
            
            let optimizedCount = 0;
            let newHtml = html;
            
            matches.forEach(imgTag => {
                let optimizedTag = imgTag;
                let wasOptimized = false;
                
                if (!imgTag.includes('width=') && !imgTag.includes('max-width')) {
                    if (imgTag.includes('style=')) {
                        optimizedTag = optimizedTag.replace(/style="([^"]*)"/, 'style="$1 max-width: 100%; height: auto;"');
                    } else {
                        optimizedTag = optimizedTag.replace('<img', '<img style="max-width: 100%; height: auto;"');
                    }
                    wasOptimized = true;
                }
                
                if (!imgTag.includes('alt=')) {
                    optimizedTag = optimizedTag.replace('<img', '<img alt=""');
                    wasOptimized = true;
                }
                
                if (!imgTag.includes('display:')) {
                    if (optimizedTag.includes('style=')) {
                        optimizedTag = optimizedTag.replace(/style="([^"]*)"/, 'style="$1 display: block;"');
                    } else {
                        optimizedTag = optimizedTag.replace('<img', '<img style="display: block;"');
                    }
                    wasOptimized = true;
                }
                
                if (wasOptimized) {
                    newHtml = newHtml.replace(imgTag, optimizedTag);
                    optimizedCount++;
                }
            });
            
            if (optimizedCount > 0) {
                editor.setValue(newHtml);
                showToast(`Optimized ${optimizedCount} image${optimizedCount > 1 ? 's' : ''} for email`);
            } else {
                showToast('All images are already optimized!', 'success');
            }
        }

        // Handle image drag & drop
        const editorElement = document.querySelector('.CodeMirror');
        if (editorElement) {
            editorElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            editorElement.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        optimizeAndInsertImage(file);
                    }
                }
            });
        }

        function optimizeAndInsertImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 600;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const isPhoto = file.type === 'image/jpeg' || file.type === 'image/jpg';
                    const outputFormat = isPhoto ? 'image/jpeg' : 'image/png';
                    const quality = isPhoto ? 0.8 : 1;
                    
                    canvas.toBlob((blob) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgHtml = `<img src="${e.target.result}" alt="" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">`;
                            
                            editor.replaceSelection(imgHtml);
                            
                            const originalSize = file.size;
                            const optimizedSize = blob.size;
                            const reduction = Math.round((1 - optimizedSize / originalSize) * 100);
                            
                            showToast(`Image optimized and inserted! Size reduced by ${reduction}% (${(optimizedSize / 1024).toFixed(1)}KB)`);
                        };
                        reader.readAsDataURL(blob);
                    }, outputFormat, quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            const icon = toast.querySelector('i');
            
            const iconClasses = {
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle',
                'success': 'fas fa-check-circle'
            };
            
            icon.className = iconClasses[type] || iconClasses.success;
            
            toast.classList.remove('error', 'warning');
            if (type === 'error') toast.classList.add('error');
            if (type === 'warning') toast.classList.add('warning');
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProject();
                        break;
                    case 'd':
                        e.preventDefault();
                        downloadHTML();
                        break;
                    case 'p':
                        e.preventDefault();
                        printHTML();
                        break;
                }
            }
        });

        // Auto-load saved project
        window.addEventListener('load', () => {
            loadProject();
        });

        // Expose functions to global scope
        window.toggleEditMode = toggleEditMode;
        window.setPreviewMode = setPreviewMode;
        window.formatHTML = formatHTML;
        window.validateEmail = validateEmail;
        window.inlineCSS = inlineCSS;
        window.showFindReplace = showFindReplace;
        window.showTemplates = showTemplates;
        window.insertSnippet = insertSnippet;
        window.optimizeImages = optimizeImages;
        window.clearEditor = clearEditor;
        window.uploadHTML = uploadHTML;
        window.downloadHTML = downloadHTML;
        window.printHTML = printHTML;
        window.emailToGmail = emailToGmail;
        window.copyToClipboard = copyToClipboard;
        window.saveProject = saveProject;
        window.closeModal = closeModal;
        window.loadTemplate = loadTemplate;
        window.findNext = findNext;
        window.replaceNext = replaceNext;
        window.replaceAll = replaceAll;

        // Variable Manager System
        let variables = [];
        let testData = {};
        let variableSets = {
            'default': ['client_name', 'email', 'phone', 'agent_name'],
            'auto': ['client_name', 'policy_number', 'vehicle_make', 'vehicle_model', 'vehicle_year', 'vin', 'coverage_type', 'premium_amount', 'deductible', 'renewal_date', 'agent_name', 'agent_phone'],
            'home': ['client_name', 'property_address', 'policy_number', 'coverage_amount', 'dwelling_coverage', 'personal_property', 'liability_coverage', 'deductible', 'premium_amount', 'renewal_date', 'agent_name'],
            'life': ['client_name', 'policy_number', 'beneficiary_name', 'coverage_amount', 'premium_amount', 'policy_type', 'effective_date', 'term_length', 'agent_name', 'agent_phone'],
            'custom': []
        };

        // Sample test data for common fields
        const sampleData = {
            'client_name': 'John Smith',
            'email': 'john.smith@email.com',
            'phone': '(555) 123-4567',
            'policy_number': 'POL-2024-123456',
            'renewal_date': 'March 15, 2025',
            'premium_amount': '$275.00',
            'agent_name': 'Bill Layne',
            'agent_phone': '336-835-1993',
            'coverage_type': 'Comprehensive Coverage',
            'effective_date': 'February 1, 2025',
            'deductible': '$500',
            'vehicle_make': 'Honda',
            'vehicle_model': 'Accord',
            'vehicle_year': '2023',
            'vin': '1HGBH41JXMN109186',
            'property_address': '123 Main Street, Elkin, NC 28621',
            'coverage_amount': '$350,000',
            'dwelling_coverage': '$280,000',
            'personal_property': '$70,000',
            'liability_coverage': '$300,000',
            'beneficiary_name': 'Jane Smith',
            'policy_type': 'Term Life',
            'term_length': '20 Years'
        };

        function showVariables() {
            loadVariables();
            renderVariables();
            renderTestDataForm();
            document.getElementById('variableModal').classList.add('show');
        }

        function loadVariables() {
            const saved = localStorage.getItem('emailVariables');
            if (saved) {
                variables = JSON.parse(saved);
                const savedTestData = localStorage.getItem('emailTestData');
                if (savedTestData) {
                    testData = JSON.parse(savedTestData);
                }
            } else {
                // Load default set
                loadVariableSet();
            }
        }

        function saveVariables() {
            localStorage.setItem('emailVariables', JSON.stringify(variables));
            localStorage.setItem('emailTestData', JSON.stringify(testData));
        }

        function loadVariableSet() {
            const setName = document.getElementById('variableSet').value;
            variables = [...variableSets[setName]];
            
            // Initialize test data with samples
            testData = {};
            variables.forEach(varName => {
                testData[varName] = sampleData[varName] || '';
            });
            
            renderVariables();
            renderTestDataForm();
            saveVariables();
        }

        function saveVariableSet() {
            const setName = prompt('Enter a name for this variable set:');
            if (setName && setName.trim()) {
                variableSets[setName.toLowerCase().replace(/\s+/g, '_')] = [...variables];
                
                // Add to select dropdown
                const select = document.getElementById('variableSet');
                const option = document.createElement('option');
                option.value = setName.toLowerCase().replace(/\s+/g, '_');
                option.textContent = setName;
                select.appendChild(option);
                select.value = option.value;
                
                showToast('Variable set saved!');
                saveVariables();
            }
        }

        function renderVariables() {
            const container = document.getElementById('variablesList');
            
            if (variables.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No variables defined. Add variables below.</p>';
                return;
            }
            
            container.innerHTML = variables.map(varName => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: white; margin-bottom: 0.5rem; border-radius: 4px;">
                    <span style="font-family: monospace; color: var(--primary);">{{${varName}}}</span>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn btn-sm" onclick="insertVariable('${varName}')" title="Insert into document">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm" onclick="removeVariable('${varName}')" title="Remove variable">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderTestDataForm() {
            const container = document.getElementById('testDataForm');
            
            if (variables.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Add variables to create test data fields.</p>';
                return;
            }
            
            container.innerHTML = variables.map(varName => `
                <div style="margin-bottom: 0.75rem;">
                    <label style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; display: block;">
                        ${varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:
                    </label>
                    <input type="text" 
                           id="test_${varName}" 
                           value="${testData[varName] || ''}"
                           placeholder="Enter test value..."
                           oninput="updateTestData('${varName}', this.value)"
                           style="width: 100%; padding: 0.5rem; font-size: 0.875rem;">
                </div>
            `).join('');
        }

        function updateTestData(varName, value) {
            testData[varName] = value;
            saveVariables();
        }

        function addVariable() {
            const input = document.getElementById('newVarName');
            const varName = input.value.trim().toLowerCase().replace(/\s+/g, '_');
            
            if (!varName) {
                showToast('Please enter a variable name', 'warning');
                return;
            }
            
            if (variables.includes(varName)) {
                showToast('Variable already exists', 'warning');
                return;
            }
            
            variables.push(varName);
            testData[varName] = '';
            input.value = '';
            
            renderVariables();
            renderTestDataForm();
            saveVariables();
            showToast(`Variable {{${varName}}} added`);
        }

        function removeVariable(varName) {
            variables = variables.filter(v => v !== varName);
            delete testData[varName];
            
            renderVariables();
            renderTestDataForm();
            saveVariables();
            showToast(`Variable {{${varName}}} removed`);
        }

        function insertVariable(varName) {
            // Add to variables if not exists
            if (!variables.includes(varName)) {
                variables.push(varName);
                testData[varName] = sampleData[varName] || '';
                renderVariables();
                renderTestDataForm();
                saveVariables();
            }
            
            // Insert into editor
            const insertion = `{{${varName}}}`;
            editor.replaceSelection(insertion);
            showToast(`Inserted {{${varName}}}`);
        }

        function clearTestData() {
            testData = {};
            variables.forEach(varName => {
                testData[varName] = '';
            });
            renderTestDataForm();
            saveVariables();
            showToast('Test data cleared');
        }

        function applyTestData() {
            let html = editor.getValue();
            let hasReplacements = false;
            
            // Save original HTML for undo
            const originalHTML = html;
            
            // Replace all variables with test data
            variables.forEach(varName => {
                const value = testData[varName] || `[${varName}]`;
                const regex = new RegExp(`{{${varName}}}`, 'gi');
                if (html.match(regex)) {
                    html = html.replace(regex, value);
                    hasReplacements = true;
                }
            });
            
            if (hasReplacements) {
                editor.setValue(html);
                updatePreview();
                showToast('Test data applied! Use "Remove Variables" to restore template.');
                
                // Store original for restoration
                sessionStorage.setItem('originalHTMLBeforeVariables', originalHTML);
            } else {
                showToast('No variables found in the HTML', 'info');
            }
        }

        function removeAllVariables() {
            // Try to restore original HTML
            const originalHTML = sessionStorage.getItem('originalHTMLBeforeVariables');
            if (originalHTML) {
                editor.setValue(originalHTML);
                sessionStorage.removeItem('originalHTMLBeforeVariables');
                showToast('Restored original template with variables');
            } else {
                // Fallback: replace test data back with variables
                let html = editor.getValue();
                let hasReplacements = false;
                
                Object.entries(testData).forEach(([varName, value]) => {
                    if (value && value.trim()) {
                        // Escape special regex characters in the value
                        const escapedValue = value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(escapedValue, 'g');
                        if (html.match(regex)) {
                            html = html.replace(regex, `{{${varName}}}`);
                            hasReplacements = true;
                        }
                    }
                });
                
                if (hasReplacements) {
                    editor.setValue(html);
                    showToast('Variables restored');
                } else {
                    showToast('No test data found to replace', 'info');
                }
            }
            updatePreview();
        }

        // Initialize variables on load
        window.addEventListener('load', () => {
            loadVariables();
        });

        // Expose Variable Manager functions
        window.showVariables = showVariables;
        window.loadVariableSet = loadVariableSet;
        window.saveVariableSet = saveVariableSet;
        window.addVariable = addVariable;
        window.removeVariable = removeVariable;
        window.insertVariable = insertVariable;
        window.updateTestData = updateTestData;
        window.clearTestData = clearTestData;
        window.applyTestData = applyTestData;
        window.removeAllVariables = removeAllVariables;

        // Expose new functions
        window.toggleIssuesPanel = toggleIssuesPanel;
        window.convertDetectedVariables = convertDetectedVariables;
        window.dismissSmartDetection = dismissSmartDetection;
        window.autoFixIssues = autoFixIssues;

        // Click outside to close issues panel
        document.addEventListener('click', function(e) {
            const issuesPanel = document.getElementById('issuesPanel');
            const issuesIndicator = document.getElementById('issuesIndicator');
            
            if (!issuesPanel.contains(e.target) && !issuesIndicator.contains(e.target)) {
                issuesPanel.classList.remove('show');
            }
        });

        // Make validation panel collapsible
        setTimeout(() => {
            const validPanel = document.getElementById('validationPanel');
            if (validPanel) {
                const header = validPanel.querySelector('h3');
                if (header) {
                    header.innerHTML = `
                        <div class="collapsible-header" onclick="toggleCollapse('validationPanel')">
                            <span>Email Compatibility Check</span>
                            <span class="collapse-arrow">▼</span>
                        </div>
                    `;
                    header.style.margin = '0';
                }
            }
        }, 100);

        function toggleCollapse(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('collapsed');
                // Save state
                localStorage.setItem(`collapsed_${panelId}`, panel.classList.contains('collapsed'));
            }
        }

        // Restore collapsed states on load
        window.addEventListener('load', () => {
            const panels = ['validationPanel'];
            panels.forEach(panelId => {
                const collapsed = localStorage.getItem(`collapsed_${panelId}`) === 'true';
                if (collapsed) {
                    const panel = document.getElementById(panelId);
                    if (panel) panel.classList.add('collapsed');
                }
            });
        });

        window.toggleCollapse = toggleCollapse;
    </script>
</body>
</html>
